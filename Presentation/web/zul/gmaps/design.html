<script type="text/Javascript">
<![CDATA[
var map;
var mOptions;
var infowindow;
var departureInput;
var arrivalInput;
var stopInput;
var departureAutocomplete;
var arrivalAutocomplete;
var stopAutocomplete;
var departureMarker;
var arrivalMarker;
var stopMarker;
var autocompleteOptions = {
    componentRestrictions: {country: 'gr'}
};
var directionsDisplay;
var directionsService;
var routes = [];
var directionDisplays = [];
var routeCoords = '-1';
var pointsCoords = '-1';
var addresses = '-1';
var geocoder;
var popularPlaces;
var selectedPopularPlace;
var myPlaces;
var selectedMyPlace;
var isDirty = false;
var departureValid = true;
var arrivalValid = true;
var stopValid = true;
var drawingMarkers = [];
var stopAddresses = [];
var drawingManager;

// load the google api loader
if (typeof(google) == 'undefined' || !google.load) {
    jq.getScript('https://www.google.com/jsapi', function () {
        loadMaps();
    });
}
else {
    // otherwise just load maps
    loadMaps();
}

// load the google maps api
function loadMaps() {
    google.load("maps", "3", {
        callback: initialize,
        language: 'el',
        other_params: 'sensor=false&libraries=drawing,places'
    });
}

function initialize() {
	geocoder = new google.maps.Geocoder();

    mOptions = {
        center: new google.maps.LatLng(38.0037082, 23.6776768),
        zoom: 16,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById("map-canvas"), mOptions);
    directionsService = new google.maps.DirectionsService;

    // START Autocomplete Management
	departureInput = (document.getElementById('departure'));
    arrivalInput = (document.getElementById('arrival'));
    stopInput = (document.getElementById('stop'));
    departureAutocomplete = new google.maps.places.Autocomplete(departureInput, autocompleteOptions);
    arrivalAutocomplete = new google.maps.places.Autocomplete(arrivalInput, autocompleteOptions);
    stopAutocomplete = new google.maps.places.Autocomplete(stopInput, autocompleteOptions);

    departureAutocomplete.bindTo('bounds', map);
    arrivalAutocomplete.bindTo('bounds', map);
    stopAutocomplete.bindTo('bounds', map);

	infowindow = new google.maps.InfoWindow();

	google.maps.event.addListener(departureAutocomplete, 'place_changed', function () {
		autocompleteSelected(departureInput, departureAutocomplete);
	});

	google.maps.event.addListener(arrivalAutocomplete, 'place_changed', function () {
		autocompleteSelected(arrivalInput, arrivalAutocomplete);
	});

	google.maps.event.addListener(stopAutocomplete, 'place_changed', function () {
		autocompleteSelected(stopInput, stopAutocomplete);
		if (stopValid) {
			var input = jq('#stop');
			setTimeout(function () {
				var container = jq('.pac-container');
				var zIndex = jq(container).css('z-index');
				jq(container).css('z-index', -1);
				input.val('');
				input.focus();
				setTimeout(function () {
					jq(container).css('z-index', zIndex);
				}, 200);
			}, 10);
			jq("#stopsTable").css('display', 'inherit');
		}
	});
	// END Autocomplete Management

	// START Drawing Management
	var toolDeparture = document.getElementById('toolDeparture');
	var toolDestination = document.getElementById('toolDestination');
	var toolStop = document.getElementById('toolStop');
	map.controls[google.maps.ControlPosition.TOP_CENTER].push(toolDeparture);
	map.controls[google.maps.ControlPosition.TOP_CENTER].push(toolDestination);
	map.controls[google.maps.ControlPosition.TOP_CENTER].push(toolStop);

	var selectedButton;
	drawingManager = new google.maps.drawing.DrawingManager({
		drawingMode: null,
		drawingControl: false,
		drawingControlOptions: {
			position: google.maps.ControlPosition.TOP_CENTER,
			drawingModes: [
				google.maps.drawing.OverlayType.MARKER
			]
		}
	});

	drawingManager.setMap(map);
	google.maps.event.addDomListener(toolDeparture, 'click', function () {
		selectedButton = toolDeparture;
		drawingManager.setOptions({
			markerOptions: {
				icon: '../../img/start-flag.png',
				draggable: true
			}
		});
		drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
	});

	google.maps.event.addDomListener(toolDestination, 'click', function () {
		selectedButton = toolDestination;
		drawingManager.setOptions({
			markerOptions: {
				icon: '../../img/finish.png',
				draggable: true
			}
		});
		drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
	});

	google.maps.event.addDomListener(toolStop, 'click', function () {
		selectedButton = toolStop;
		drawingManager.setOptions({
			markerOptions: {
				icon: '../../img/stop.png',
				draggable: true
			}
		});
		drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
	});

	google.maps.event.addListener(drawingManager, 'markercomplete', function(marker) {
		isDirty = true;
		drawingManager.setDrawingMode(null);
		(function (selectedId, mark) {
			geocoder.geocode({'latLng': marker.getPosition()}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					if (selectedId == 'toolDeparture') {

						// Create START marker
						departureMarker = mark;
						selectedButton.disabled = true;
						jq('#departure').val(results[0].formatted_address);
						mark.setOptions({
							title: results[0].formatted_address
						});
						(function (title, startMarker) {
							google.maps.event.addListener(startMarker, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,startMarker);
							});
							google.maps.event.addListener(startMarker, 'dragend', function() {
								geocoder.geocode({'latLng': startMarker.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#departure').val(results[0].formatted_address);
										startMarker.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(startMarker, 'click');
										google.maps.event.addListener(startMarker, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,startMarker);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, mark);

					} else if (selectedId == 'toolDestination') {

						// Create END Marker
						arrivalMarker = mark;
						selectedButton.disabled = true;
						jq('#arrival').val(results[0].formatted_address);
						mark.setOptions({
							title: results[0].formatted_address
						});
						(function (title, startMarker) {
							google.maps.event.addListener(startMarker, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,startMarker);
							});
							google.maps.event.addListener(startMarker, 'dragend', function() {
								geocoder.geocode({'latLng': startMarker.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#arrival').val(results[0].formatted_address);
										startMarker.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(startMarker, 'click');
										google.maps.event.addListener(startMarker, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,startMarker);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, mark);

					} else if (selectedId == 'toolStop') {

						// Create STOP marker
						stopAddresses.push(results[0].formatted_address);

						mark.setOptions({
							title: results[0].formatted_address
						});

						jq("#sortable").append("<li id=\"" + results[0].formatted_address + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + results[0].formatted_address + "  <span class=\"deleteStop\">[x]</span></li>");
						jq("#stopsTable").css('display', 'inherit');
						jq("#sortable .deleteStop").click(function () {
		//			        alert(jq(this).parent().attr('id'));
							jq(this).parent().remove();

							for (i=0; i<drawingMarkers.length; i++) {
								if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
									drawingMarkers[i].setMap(null);
								}
							}
							var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
							if (elementIndex > -1) {
								stopAddresses.splice(elementIndex, 1);
							}

							if (jq("#sortable").sortable("toArray").length == 0) {
								jq("#stopsTable").css('display', 'none');
							}
							isDirty = true;
						});
						(function (title, mark, stopAddr) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragstart', function() {
								var m;
								for (m=0; m<stopAddr.length; m++) {
									if (mark.title == stopAddr[m]) {
										stopAddr[m] = 0;
									}
								}
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});

										var m;
										for (m=0; m<stopAddr.length; m++) {
											if (stopAddr[m] == 0) {
												stopAddr[m] = results[0].formatted_address;
											}
										}

										jq('#sortable > li').each(function(){
											jq(this).remove();
										});

										var k;
										for (k=0; k<stopAddr.length; k++) {
											jq("#sortable").append("<li id=\"" + stopAddr[k] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[k] + "  <span class=\"deleteStop\">[x]</span></li>");
											jq("#stopsTable").css('display', 'inherit');
											jq("#sortable .deleteStop").click(function () {
												jq(this).parent().remove();
												var l;
												for (l=0; l<drawingMarkers.length; l++) {
													if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
														drawingMarkers[l].setMap(null);
													}
												}
												var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
												if (elementIndex > -1) {
													stopAddr.splice(elementIndex, 1);
												}
												if (jq("#sortable").sortable("toArray").length == 0) {
													jq("#stopsTable").css('display', 'none');
												}
											});
										}
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, mark, stopAddresses);
					}
				}
				drawingMarkers.push(mark);
			});

			google.maps.event.addListener(marker, 'dragend', function() {
				geocoder.geocode({'latLng': marker.getPosition()}, function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						if (selectedId == 'toolDeparture') {
							selectedButton.disabled = true;
							jq('#departure').val(results[0].formatted_address);
						} else if (selectedId == 'toolDestination') {
							selectedButton.disabled = true;
							jq('#arrival').val(results[0].formatted_address);
						}
					}
				});
			});
		})(selectedButton.id, marker);
	});
	// END Drawing Management

    jq("#sortable").sortable({
	    update: function(event, ui) {
		    stopAddresses.length = 0;
		    var stops = jq(this).sortable("toArray");
			for (i=0; i<stops.length; i++) {
				stopAddresses[i] = stops[i];
			}
		    isDirty = true;
	    }
    });
    jq("#sortable").sortable("option", "cursor", "move");
    jq("#sortable").disableSelection();

    jq("#designButton").click(function () {
        displayRoute(departureInput.value, arrivalInput.value);
        if(jq("#sortable li").length == 0)
            alert("Συμβουλή: Για τη διευκόλυνση του εντοπισμού της διαδρομής σας προτείνεται ο προσδιορισμός" +
                    " στάσεων");
    });

    jq("#resetButton").click(function () {
        clearDirections();
	    document.getElementById('toolDeparture').disabled = false;
	    document.getElementById('toolDestination').disabled = false;
	    drawingManager.setDrawingMode(null);

	    departureInput.value = null;
	    departureMarker = null;

	    arrivalInput.value = null;
	    arrivalMarker = null;

	    jq('#sortable > li').each(function(){
		    jq(this).remove();
	    });
	    jq("#stopsTable").css('display', 'none');

	    stopAddresses.length = 0;

    });

    jq("#dialog-form").dialog({
        autoOpen: false,
        height: 400,
        width: 500,
        modal: true,
        buttons: {
            "Επιλογή": function () {
	            acceptPopularPlace(jq(this).data('inputId'), jq(this));
            },
            "Ακύρωση": function () {
                selectedPopularPlace = null;
                jq(this).dialog("close");
	            jq('#selectable').unbind("dblclick");
            }
        },
        close: function () {
            selectedPopularPlace = null;
            jq('#selectable .ui-selected').removeClass('ui-selected');
	        jq('#selectable').unbind("dblclick");
        }
    });

    jq("#dialog-form-my-places").dialog({
        autoOpen: false,
        height: 400,
        width: 500,
        modal: true,
        buttons: {
            "Επιλογή": function () {
	            acceptMyPlace(jq(this).data('inputId'), jq(this));
            },
            "Ακύρωση": function () {
                selectedMyPlace = null;
                jq(this).dialog("close");
	            jq('#myPlacesSelectable').unbind("dblclick");
            }
        },
        close: function () {
            selectedMyPlace = null;
            jq('#myPlacesSelectable .ui-selected').removeClass('ui-selected');
	        jq('#myPlacesSelectable').unbind("dblclick");
        }
    });

    jq("#depListPlaces").button().click(function () {
	    jq('#selectable').data('inputId', 'departure').dblclick(function() {
		    acceptPopularPlace(jq(this).data('inputId'), jq('#dialog-form'));
	    });
        jq("#dialog-form").data('inputId', 'departure').dialog("open");
    });

    jq("#arrListPlaces").button().click(function () {
	    jq('#selectable').data('inputId', 'arrival').dblclick(function() {
		    acceptPopularPlace(jq(this).data('inputId'), jq('#dialog-form'));
	    });
        jq("#dialog-form").data('inputId', 'arrival').dialog("open");
    });

    jq("#stopListPlaces").button().click(function () {
	    jq('#selectable').data('inputId', 'stop').dblclick(function() {
		    acceptPopularPlace(jq(this).data('inputId'), jq('#dialog-form'));
	    });
        jq("#dialog-form").data('inputId', 'stop').dialog("open");
    });

    jq("#depHomePlace").button().click(function () {
	    jq('#myPlacesSelectable').data('inputId', 'departure').dblclick(function() {
		    acceptMyPlace(jq(this).data('inputId'), jq('#dialog-form-my-places'));
	    });
        jq("#dialog-form-my-places").data('inputId', 'departure').dialog("open");
    });

    jq("#arrHomePlace").button().click(function () {
	    jq('#myPlacesSelectable').data('inputId', 'arrival').dblclick(function() {
		    acceptMyPlace(jq(this).data('inputId'), jq('#dialog-form-my-places'));
	    });
        jq("#dialog-form-my-places").data('inputId', 'arrival').dialog("open");
    });

    jq("#stopHomePlace").button().click(function () {
	    jq('#myPlacesSelectable').data('inputId', 'stop').dblclick(function() {
		    acceptMyPlace(jq(this).data('inputId'), jq('#dialog-form-my-places'));
	    });
        jq("#dialog-form-my-places").data('inputId', 'stop').dialog("open");
    });

    jq("#selectable").selectable({
        selected: function (event, ui) {
            selectedPopularPlace = ui.selected.id;
            jq(ui.selected).addClass("ui-selected").siblings().removeClass("ui-selected");
        }
    });

    jq("#myPlacesSelectable").selectable({
        selected: function (event, ui) {
            selectedMyPlace = ui.selected.id;
            jq(ui.selected).addClass("ui-selected").siblings().removeClass("ui-selected");
        }
    });


    // START Load Map Data for edit
	if (routeCoords != '-1') {
		clearDirections();

		var directions = routeCoords.split("#");
		var departure, arrival, type;
		var start, end;
		var coordinates;
		for (i = 0; i < directions.length; i++) {
			var segments = directions[i].split("|");
			coordinates = segments[0].split(",");
			start = new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim());

			coordinates = segments[1].split(",");
			end = new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim());

			var waypoints = [];
			if (segments.length > 2) {
				for (var j=2; j<segments.length; j++) {
					coordinates = segments[j].split(",");
					waypoints.push({
						location: new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim()),
						stopover: false
					});
				}
			}

			(function (idx) {
				directionsService.route({ 'origin': start, 'destination': end, 'waypoints': waypoints, 'travelMode': google.maps.DirectionsTravelMode.DRIVING}, function (response, status) {
					if (status == google.maps.DirectionsStatus.OK) {
						renderDirections(response, true, idx, false);
					}
				});
			})(i);
		}

		var points = pointsCoords.split("|");
		var address = addresses.split("|");
		for (i = 0; i < points.length; i++) {
			coordinates = points[i].split(",");

			if (i == 0) {
			    jq("#departure").val(address[i]);
				var startMarker = new google.maps.Marker({
					position: new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim()),
					map: map,
					draggable: true,
					icon: {
						url: '../../img/start-flag.png'
					},
					title: address[i]
				});

				if (departureMarker != null) {
					departureMarker.setMap(null);
				}
				departureMarker = startMarker;

				(function (title, mark) {
					google.maps.event.addListener(mark, 'click', function() {
						infowindow.setOptions({
							content: title
						});
						infowindow.open(map,mark);
					});
					google.maps.event.addListener(mark, 'dragend', function() {
						geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
							if (status == google.maps.GeocoderStatus.OK) {
								toolDeparture.disabled = true;
								jq('#departure').val(results[0].formatted_address);
								mark.setOptions({
									title: results[0].formatted_address
								});
								google.maps.event.clearListeners(mark, 'click');
								google.maps.event.addListener(mark, 'click', function() {
									infowindow.setOptions({
										content: results[0].formatted_address
									});
									infowindow.open(map,mark);
								});
							}
						});
						isDirty = true;
					});
				})(address[i], startMarker);
				drawingMarkers.push(startMarker);
			}
			if (i > 0 && i < points.length - 1) {
				stopAddresses.push(address[i]);
				jq("#sortable").append("<li id=\"" + address[i] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + address[i] + "  <span class=\"deleteStop\">[x]</span></li>");
		        jq("#stopsTable").css('display', 'inherit');
		        jq("#sortable .deleteStop").click(function () {
//			        alert(jq(this).parent().attr('id'));
		            jq(this).parent().remove();

			        for (i=0; i<drawingMarkers.length; i++) {
				        if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
					        drawingMarkers[i].setMap(null);
				        }
			        }
			        var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
			        if (elementIndex > -1) {
				        stopAddresses.splice(elementIndex, 1);
			        }

		            if (jq("#sortable").sortable("toArray").length == 0) {
		                jq("#stopsTable").css('display', 'none');
		            }
			        isDirty = true;
		        });

				var stopMarker = new google.maps.Marker({
					position: new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim()),
					map: map,
					draggable: true,
					icon: {
						url: '../../img/stop.png'
					},
					title: address[i]
				});
				(function (title, mark, stopAddr) {
					google.maps.event.addListener(mark, 'click', function() {
						infowindow.setOptions({
							content: title
						});
						infowindow.open(map,mark);
					});
					google.maps.event.addListener(mark, 'dragstart', function() {
						var m;
						for (m=0; m<stopAddr.length; m++) {
							if (mark.title == stopAddr[m]) {
								stopAddr[m] = 0;
							}
						}
					});
					google.maps.event.addListener(mark, 'dragend', function() {
						geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
							if (status == google.maps.GeocoderStatus.OK) {
								mark.setOptions({
									title: results[0].formatted_address
								});
								google.maps.event.clearListeners(mark, 'click');
								google.maps.event.addListener(mark, 'click', function() {
									infowindow.setOptions({
										content: results[0].formatted_address
									});
									infowindow.open(map,mark);
								});

								var m;
								for (m=0; m<stopAddr.length; m++) {
									if (stopAddr[m] == 0) {
										stopAddr[m] = results[0].formatted_address;
									}
								}

								jq('#sortable > li').each(function(){
									jq(this).remove();
								});

								var k;
								for (k=0; k<stopAddr.length; k++) {
									jq("#sortable").append("<li id=\"" + stopAddr[k] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[k] + "  <span class=\"deleteStop\">[x]</span></li>");
									jq("#stopsTable").css('display', 'inherit');
									jq("#sortable .deleteStop").click(function () {
										jq(this).parent().remove();
										var l;
										for (l=0; l<drawingMarkers.length; l++) {
											if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
												drawingMarkers[l].setMap(null);
											}
										}
										var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
										if (elementIndex > -1) {
											stopAddr.splice(elementIndex, 1);
										}
										if (jq("#sortable").sortable("toArray").length == 0) {
											jq("#stopsTable").css('display', 'none');
										}
									});
								}
							}
						});
						isDirty = true;
					});
				})(address[i], stopMarker, stopAddresses);
				drawingMarkers.push(stopMarker);
			}
			if (i == points.length - 1) {
			    jq("#arrival").val(address[i]);
				var endMarker = new google.maps.Marker({
					position: new google.maps.LatLng(coordinates[0].trim(), coordinates[1].trim()),
					map: map,
					draggable: true,
					icon: {
						url: '../../img/finish.png'
					},
					title: address[i]
				});

				if (arrivalMarker != null) {
					arrivalMarker.setMap(null);
				}
				arrivalMarker = endMarker;

				(function (title, mark) {
					google.maps.event.addListener(mark, 'click', function() {
						infowindow.setOptions({
							content: title
						});
						infowindow.open(map,mark);
					});
					google.maps.event.addListener(mark, 'dragend', function() {
						geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
							if (status == google.maps.GeocoderStatus.OK) {
								toolDestination.disabled = true;
								jq('#arrival').val(results[0].formatted_address);
								mark.setOptions({
									title: results[0].formatted_address
								});
								google.maps.event.clearListeners(mark, 'click');
								google.maps.event.addListener(mark, 'click', function() {
									infowindow.setOptions({
										content: results[0].formatted_address
									});
									infowindow.open(map,mark);
								});
							}
						});
						isDirty = true;
					});
				})(address[i], endMarker);
				drawingMarkers.push(endMarker);
			}
		}

		toolDeparture.disabled = true;
		toolDestination.disabled = true;
    }
	// END Load Map Data for edit


    if (popularPlaces != null) {
        for (var k = 0; k < popularPlaces.length; k++) {
            jq("#selectable").append("<li id=\"" + popularPlaces[k][1] + "\" class=\"ui-widget-content\">" + popularPlaces[k][0] + "</li>");
        }
    }

    if (myPlaces != null) {
        for (k = 0; k < myPlaces.length; k++) {
            jq("#myPlacesSelectable").append("<li id=\"" + myPlaces[k][1] + "\" class=\"ui-widget-content\">" + myPlaces[k][0] + "</li>");
        }
    }

	jq('#departure').keyup(function() {
		if (jq('#departure').val() == '') {
			jq("#departure").css("border-color", "gray");
		}
		isDirty = true;
	});

	jq('#arrival').keyup(function() {
		if (jq('#arrival').val() == '') {
			jq("#arrival").css("border-color", "gray");
		}
		isDirty = true;
	});

	jq('#stop').keyup(function() {
		if (jq('#stop').val() == '') {
			jq("#stop").css("border-color", "gray");
		}
		isDirty = true;
	});

	jq('#departure').blur(function() {
		if (jq('#departure').val() == '') {
			jq("#departure").css("border-color", "gray");
		} else {
			google.maps.event.trigger(departureAutocomplete, 'place_changed');
		}
	});

	jq('#arrival').blur(function() {
		if (jq('#arrival').val() == '') {
			jq("#arrival").css("border-color", "gray");
		} else {
			google.maps.event.trigger(arrivalAutocomplete, 'place_changed');
		}
	});

//	jq('#stop').blur(function() {
//		if (jq('#stop').val() == '') {
//			jq("#stop").css("border-color", "gray");
//		} else {
//			google.maps.event.trigger(stopAutocomplete, 'place_changed');
//		}
//	});
}

function acceptPopularPlace(inputId, dialog) {
	var input = jq('#' + inputId);
	if (selectedPopularPlace != null) {
		if (inputId != 'stop') {
			input.val(selectedPopularPlace);
		}

		(function (id) {
			geocoder.geocode({ 'address': selectedPopularPlace}, function (results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
						map: map,
						draggable: true,
						position: results[0].geometry.location
					});
					if (id == 'stop') {
						marker.setOptions({
							icon: {
								url: '../../img/stop.png'
							},
							title: results[0].formatted_address
						});

						stopAddresses.push(results[0].formatted_address);

						jq("#sortable").append("<li id=\"" + results[0].formatted_address + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + results[0].formatted_address + "  <span class=\"deleteStop\">[x]</span></li>");
						jq("#stopsTable").css('display', 'inherit');
						jq("#sortable .deleteStop").click(function () {
		//			        alert(jq(this).parent().attr('id'));
							jq(this).parent().remove();

							for (i=0; i<drawingMarkers.length; i++) {
								if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
									drawingMarkers[i].setMap(null);
								}
							}
							var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
							if (elementIndex > -1) {
								stopAddresses.splice(elementIndex, 1);
							}

							if (jq("#sortable").sortable("toArray").length == 0) {
								jq("#stopsTable").css('display', 'none');
							}
							isDirty = true;
						});

						(function (title, mark, stopAddr) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragstart', function() {
								var m;
								for (m=0; m<stopAddr.length; m++) {
									if (mark.title == stopAddr[m]) {
										stopAddr[m] = 0;
									}
								}
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});

										var m;
										for (m=0; m<stopAddr.length; m++) {
											if (stopAddr[m] == 0) {
												stopAddr[m] = results[0].formatted_address;
											}
										}

										jq('#sortable > li').each(function(){
											jq(this).remove();
										});

										var k;
										for (k=0; k<stopAddr.length; k++) {
											jq("#sortable").append("<li id=\"" + stopAddr[k] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[k] + "  <span class=\"deleteStop\">[x]</span></li>");
											jq("#stopsTable").css('display', 'inherit');
											jq("#sortable .deleteStop").click(function () {
												jq(this).parent().remove();
												var l;
												for (l=0; l<drawingMarkers.length; l++) {
													if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
														drawingMarkers[l].setMap(null);
													}
												}
												var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
												if (elementIndex > -1) {
													stopAddr.splice(elementIndex, 1);
												}
												if (jq("#sortable").sortable("toArray").length == 0) {
													jq("#stopsTable").css('display', 'none');
												}
											});
										}
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker, stopAddresses);

					} else if (id == 'departure') {

						marker.setOptions({
							icon: {
								url: '../../img/start-flag.png'
							},
							title: results[0].formatted_address
						});

						if (departureMarker != null) {
							departureMarker.setMap(null);
						}
						departureMarker = marker;

						(function (title, mark) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#departure').val(results[0].formatted_address);
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker);

					} else if (id == 'arrival') {

						marker.setOptions({
							icon: {
								url: '../../img/finish.png'
							},
							title: results[0].formatted_address
						});

						if (arrivalMarker != null) {
							arrivalMarker.setMap(null);
						}
						arrivalMarker = marker;

						(function (title, mark) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#arrival').val(results[0].formatted_address);
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker);

					}
					drawingMarkers.push(marker);
				} else {
					alert("Geocode was not successful for the following reason: " + status);
				}
			});
		})(inputId);

		isDirty = true;
		if (inputId == 'departure') {
			departureValid = true;
			document.getElementById('toolDeparture').disabled = true;
			drawingManager.setDrawingMode(null);
		} else if (inputId == 'arrival') {
			arrivalValid = true;
			document.getElementById('toolDestination').disabled = true;
			drawingManager.setDrawingMode(null);
		} else if (inputId == 'stop') {
			stopValid = true;
		}
		jq("#" + inputId).css("border-color", "gray");

		dialog.dialog("close");
	}
}

function acceptMyPlace(inputId, dialog) {
	var input = jq('#' + inputId);
	if (selectedMyPlace != null) {
		if (inputId != 'stop') {
			input.val(selectedMyPlace);
		}

		(function (id) {
			geocoder.geocode({ 'address': selectedMyPlace}, function (results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
						map: map,
						draggable: true,
						position: results[0].geometry.location
					});
					if (id == 'stop') {
						marker.setOptions({
							icon: {
								url: '../../img/stop.png'
							},
							title: results[0].formatted_address
						});

						stopAddresses.push(results[0].formatted_address);

						jq("#sortable").append("<li id=\"" + results[0].formatted_address + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + results[0].formatted_address + "  <span class=\"deleteStop\">[x]</span></li>");
						jq("#stopsTable").css('display', 'inherit');
						jq("#sortable .deleteStop").click(function () {
							jq(this).parent().remove();

							for (i=0; i<drawingMarkers.length; i++) {
								if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
									drawingMarkers[i].setMap(null);
								}
							}
							var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
							if (elementIndex > -1) {
								stopAddresses.splice(elementIndex, 1);
							}

							if (jq("#sortable").sortable("toArray").length == 0) {
								jq("#stopsTable").css('display', 'none');
							}
							isDirty = true;
						});

						(function (title, mark, stopAddr) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragstart', function() {
								var m;
								for (m=0; m<stopAddr.length; m++) {
									if (mark.title == stopAddr[m]) {
										stopAddr[m] = 0;
									}
								}
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});

										var m;
										for (m=0; m<stopAddr.length; m++) {
											if (stopAddr[m] == 0) {
												stopAddr[m] = results[0].formatted_address;
											}
										}

										jq('#sortable > li').each(function(){
											jq(this).remove();
										});

										var k;
										for (k=0; k<stopAddr.length; k++) {
											jq("#sortable").append("<li id=\"" + stopAddr[k] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[k] + "  <span class=\"deleteStop\">[x]</span></li>");
											jq("#stopsTable").css('display', 'inherit');
											jq("#sortable .deleteStop").click(function () {
												jq(this).parent().remove();
												var l;
												for (l=0; l<drawingMarkers.length; l++) {
													if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
														drawingMarkers[l].setMap(null);
													}
												}
												var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
												if (elementIndex > -1) {
													stopAddr.splice(elementIndex, 1);
												}
												if (jq("#sortable").sortable("toArray").length == 0) {
													jq("#stopsTable").css('display', 'none');
												}
											});
										}
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker, stopAddresses);

					} else if (id == 'departure') {

						marker.setOptions({
							icon: {
								url: '../../img/start-flag.png'
							},
							title: results[0].formatted_address
						});

						if (departureMarker != null) {
							departureMarker.setMap(null);
						}
						departureMarker = marker;

						(function (title, mark) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#departure').val(results[0].formatted_address);
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker);

					} else if (id == 'arrival') {

						marker.setOptions({
							icon: {
								url: '../../img/finish.png'
							},
							title: results[0].formatted_address
						});

						if (arrivalMarker != null) {
							arrivalMarker.setMap(null);
						}
						arrivalMarker = marker;

						(function (title, mark) {
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: title
								});
								infowindow.open(map,mark);
							});
							google.maps.event.addListener(mark, 'dragend', function() {
								geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
									if (status == google.maps.GeocoderStatus.OK) {
										jq('#arrival').val(results[0].formatted_address);
										mark.setOptions({
											title: results[0].formatted_address
										});
										google.maps.event.clearListeners(mark, 'click');
										google.maps.event.addListener(mark, 'click', function() {
											infowindow.setOptions({
												content: results[0].formatted_address
											});
											infowindow.open(map,mark);
										});
									}
								});
								isDirty = true;
							});
						})(results[0].formatted_address, marker);

					}
					drawingMarkers.push(marker);
				} else {
					alert("Geocode was not successful for the following reason: " + status);
				}
			});
		})(inputId);

		isDirty = true;
		if (inputId == 'departure') {
			departureValid = true;
			document.getElementById('toolDeparture').disabled = true;
			drawingManager.setDrawingMode(null);
		} else if (inputId == 'arrival') {
			arrivalValid = true;
			document.getElementById('toolDestination').disabled = true;
			drawingManager.setDrawingMode(null);
		} else if (inputId == 'stop') {
			stopValid = true;
		}
		jq("#"+ inputId).css("border-color", "gray");

		dialog.dialog("close");
	}
}


function autocompleteSelected(input, autocomplete) {
    var error = false;
	infowindow.close();
    var place = autocomplete.getPlace();

	isDirty = true;

	// Autocomplete validation
	if (input.id == 'departure') {
		if (place == null || (!place.geometry)) {
			// Inform the user that the place was not found
			jq("#departure").css("border-color", "red");
	        departureValid = false;
			error = true;
		} else {
			jq("#departure").css("border-color", "gray");
			departureValid = true;
		}
	} else if (input.id == 'arrival') {
		if (place == null || (!place.geometry)) {
			// Inform the user that the place was not found
			jq("#arrival").css("border-color", "red");
			error = true;
			arrivalValid = false;
		} else {
			jq("#arrival").css("border-color", "gray");
			arrivalValid = true;
		}
	} else if (input.id == 'stop') {
		if (place == null || (!place.geometry)) {
			// Inform the user that the place was not found
			jq("#stop").css("border-color", "red");
			error = true;
			stopValid = false;
		} else {
			jq("#stop").css("border-color", "gray");
			stopValid = true;
		}
	}

	if (!error) {
		var marker = new google.maps.Marker({
			map: map,
			draggable: true,
			position: place.geometry.location
		});
		if (input.id == 'departure') {
			// Create START marker
			document.getElementById('toolDeparture').disabled = true;
			drawingManager.setDrawingMode(null);

			marker.setOptions({
				icon: {
					url: '../../img/start-flag.png'
				},
				title: place.formatted_address
			});

			if (departureMarker != null) {
				departureMarker.setMap(null);
			}
			departureMarker = marker;

			(function (title, mark) {
				google.maps.event.addListener(mark, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							jq('#departure').val(results[0].formatted_address);
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});
						}
					});
					isDirty = true;
				});
			})(place.formatted_address, marker);

		} else if (input.id == 'arrival') {

			// Create END marker
			document.getElementById('toolDestination').disabled = true;
			drawingManager.setDrawingMode(null);

			marker.setOptions({
				icon: {
					url: '../../img/finish.png'
				},
				title: place.formatted_address
			});

			if (arrivalMarker != null) {
				arrivalMarker.setMap(null);
			}
			arrivalMarker = marker;

			(function (title, mark) {
				google.maps.event.addListener(mark, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							jq('#arrival').val(results[0].formatted_address);
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});
						}
					});
					isDirty = true;
				});
			})(place.formatted_address, marker);

		} else if (input.id == 'stop') {

			// Create STOP marker
			marker.setOptions({
				icon: {
					url: '../../img/stop.png'
				},
				title: place.formatted_address
			});

			stopAddresses.push(place.formatted_address);

			jq("#sortable").append("<li id=\"" + place.formatted_address + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + place.formatted_address + "  <span class=\"deleteStop\">[x]</span></li>");
			jq("#stopsTable").css('display', 'inherit');
			jq("#sortable .deleteStop").click(function () {
				jq(this).parent().remove();

				for (i=0; i<drawingMarkers.length; i++) {
					if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
						drawingMarkers[i].setMap(null);
					}
				}
				var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
				if (elementIndex > -1) {
					stopAddresses.splice(elementIndex, 1);
				}

				if (jq("#sortable").sortable("toArray").length == 0) {
					jq("#stopsTable").css('display', 'none');
				}
				isDirty = true;
			});

			(function (title, mark, stopAddr) {
				google.maps.event.addListener(mark, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragstart', function() {
					var m;
					for (m=0; m<stopAddr.length; m++) {
						if (mark.title == stopAddr[m]) {
							stopAddr[m] = 0;
						}
					}
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});

							var m;
							for (m=0; m<stopAddr.length; m++) {
								if (stopAddr[m] == 0) {
									stopAddr[m] = results[0].formatted_address;
								}
							}

							jq('#sortable > li').each(function(){
								jq(this).remove();
							});

							var k;
							for (k=0; k<stopAddr.length; k++) {
								jq("#sortable").append("<li id=\"" + stopAddr[k] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[k] + "  <span class=\"deleteStop\">[x]</span></li>");
								jq("#stopsTable").css('display', 'inherit');
								jq("#sortable .deleteStop").click(function () {
									jq(this).parent().remove();
									var l;
									for (l=0; l<drawingMarkers.length; l++) {
										if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
											drawingMarkers[l].setMap(null);
										}
									}
									var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
									if (elementIndex > -1) {
										stopAddr.splice(elementIndex, 1);
									}
									if (jq("#sortable").sortable("toArray").length == 0) {
										jq("#stopsTable").css('display', 'none');
									}
								});
							}
						}
					});
					isDirty = true;
				});
			})(place.formatted_address, marker, stopAddresses);

		}

	    // If the place has a geometry, then present it on a map.
	    if (place.geometry.viewport) {
	        map.fitBounds(place.geometry.viewport);
	    } else {
	        map.setCenter(place.geometry.location);
	        map.setZoom(17);
	    }

		drawingMarkers.push(marker);
	}
}

function displayRoute(originAddress, destinationAddress) {
    if (originAddress != '' && destinationAddress != '') {
        var i;

        routes.length = 0;
        routes.push(originAddress);
        if (stopAddresses != null) {
            for (i = 0; i < stopAddresses.length; i++) {
	            routes.push(stopAddresses[i]);
            }
        }
        routes.push(destinationAddress);

//	    for (i = 0; i < routes.length; i++) {
//		    alert(routes[i]);
//	    }

        clearDirections();

	    for (i = 0; i < routes.length - 1; i++) {
		    (function (idx) {
	            directionsService.route({ 'origin': routes[i], 'destination': routes[i + 1], 'travelMode': google.maps.DirectionsTravelMode.DRIVING}, function (response, status) {
	                if (status == google.maps.DirectionsStatus.OK) {
		                renderDirections(response, true, idx, true);
	                }
	            });
		    })(i);
        }

        populateZKTextbox('startingPoint', originAddress);
        populateZKTextbox('destinationPoint', destinationAddress);

	    jq("#stop").val(null);
	    jq("#stop").css("border-color", "gray");
	    isDirty = false;
    }
}

function renderDirections(result, isDragable, i, createMarkers) {
    // Use noimage because suppressMarkers = true hides also the waypoints
	var directionDisplay = new google.maps.DirectionsRenderer({
        draggable: isDragable,
        suppressMarkers: false,
        markerOptions: {
            icon: {
                url: 'noimage'
            },
            draggable: false
        },
	    index: i
    });
    directionDisplay.setMap(map);
    directionDisplay.setDirections(result);

	if (createMarkers) {
		// Display START Marker
		if (i == 0) {
			var startMarker = new google.maps.Marker({
				position: result.routes[0].legs[0].start_location,
				map: map,
				draggable: true,
				icon: {
					url: '../../img/start-flag.png'
				},
				title: result.routes[0].legs[0].start_address
			});
			(function (title, mark) {
				google.maps.event.addListener(mark, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							jq('#departure').val(results[0].formatted_address);
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});
						}
					});
					isDirty = true;
				});
			})(result.routes[0].legs[0].start_address, startMarker);
			drawingMarkers.push(startMarker);
		}

		// Display END Marker
		if (i == routes.length - 2) {
			var endMarker = new google.maps.Marker({
				position: result.routes[0].legs[0].end_location,
				map: map,
				draggable: true,
				icon: {
					url: '../../img/finish.png'
				},
				title: result.routes[0].legs[0].end_address
			});
			(function (title, mark) {
				google.maps.event.addListener(endMarker, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							jq('#arrival').val(results[0].formatted_address);
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});
						}
					});
					isDirty = true;
				});
			})(result.routes[0].legs[0].end_address, endMarker);
			drawingMarkers.push(endMarker);
		}

		// Display STOP marker
		if (routes.length > 2 && i > 0) {
			var stopMarker = new google.maps.Marker({
				position: result.routes[0].legs[0].start_location,
				map: map,
				draggable: true,
				icon: {
					url: '../../img/stop.png'
				},
				title: stopAddresses[i-1]
			});
			(function (title, mark, stopAddr) {
				google.maps.event.addListener(mark, 'click', function() {
					infowindow.setOptions({
						content: title
					});
					infowindow.open(map,mark);
				});
				google.maps.event.addListener(mark, 'dragstart', function() {
					for (m=0; m<stopAddr.length; m++) {
						if (title == stopAddr[m]) {
							stopAddr[m] = 0;
						}
					}
				});
				google.maps.event.addListener(mark, 'dragend', function() {
					geocoder.geocode({'latLng': mark.getPosition()}, function(results, status) {
						if (status == google.maps.GeocoderStatus.OK) {
							mark.setOptions({
								title: results[0].formatted_address
							});
							google.maps.event.clearListeners(mark, 'click');
							google.maps.event.addListener(mark, 'click', function() {
								infowindow.setOptions({
									content: results[0].formatted_address
								});
								infowindow.open(map,mark);
							});

							for (m=0; m<stopAddr.length; m++) {
								if (stopAddr[m] == 0) {
									stopAddr[m] = results[0].formatted_address;
								}
							}

							jq('#sortable > li').each(function(){
								jq(this).remove();
							});

							for (m=0; m<stopAddr.length; m++) {
								jq("#sortable").append("<li id=\"" + stopAddr[m] + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + stopAddr[m] + "  <span class=\"deleteStop\">[x]</span></li>");
								jq("#stopsTable").css('display', 'inherit');
								jq("#sortable .deleteStop").click(function () {
									jq(this).parent().remove();
									var l;
									for (l=0; l<drawingMarkers.length; l++) {
										if (drawingMarkers[l].title == jq(this).parent().attr('id')) {
											drawingMarkers[l].setMap(null);
										}
									}
									var elementIndex = stopAddr.indexOf(jq(this).parent().attr('id'));
									if (elementIndex > -1) {
										stopAddr.splice(elementIndex, 1);
									}
									if (jq("#sortable").sortable("toArray").length == 0) {
										jq("#stopsTable").css('display', 'none');
									}
								});
							}
						}
					});
					isDirty = true;
				});
			})(stopAddresses[i-1], stopMarker, stopAddresses);
			drawingMarkers.push(stopMarker);
		}
	}
    directionDisplays.push(directionDisplay);
}

function clearDirections() {
    for (var i = 0; i < directionDisplays.length; i++) {
        directionDisplays[i].setMap(null);
    }
    directionDisplays.length = 0;

    for (i = 0; i < drawingMarkers.length; i++) {
        drawingMarkers[i].setMap(null);
    }
	drawingMarkers.length = 0;
}

function save() {
	if (departureValid && arrivalValid) {
		if ((jq("#departure").val() == "") || (jq("#arrival").val() == "")) {
		    if (jq("#departure").val() == "") {
			    jq("#departure").css("border-color", "red");
		    } else {
			    jq("#departure").css("border-color", "grey");
		    }
		    if (jq("#arrival").val() == "") {
	            jq("#arrival").css("border-color", "red");
		    } else {
			    jq("#arrival").css("border-color", "grey");
		    }
	    } else {
		    jq("#departure").css("border-color", "grey");
		    jq("#arrival").css("border-color", "grey");

			if (!isDirty) {
			    // START sort direction results (they are not sorted because the direction service is asynchronous)
			    var sortedDirectionDisplays = [];
			    var currentIndex = 0;
			    while (currentIndex < directionDisplays.length) {
				    for (n=0; n<directionDisplays.length; n++) {
					    if (directionDisplays[n].index == currentIndex) {
						    sortedDirectionDisplays.push(directionDisplays[n]);
						    currentIndex++;
					    }
				    }
			    }
			    // END sort direction results (they are not sorted because the direction service is asynchronous)

				// START get cooordinates for the entire path
			    var n, routelegs, linestring = '';
			    var bounds = new google.maps.LatLngBounds();
			    var polyline = new google.maps.Polyline({
				    path: [],
				    strokeColor: '#FF0000',
				    strokeWeight: 1
			    });

//			    for (n=0; n<directionDisplays.length; n++) {
//				    alert('Raw Index: ' + directionDisplays[n].index);
//			    }

			    for (n=0; n<sortedDirectionDisplays.length; n++) {
//				    alert('Sorted Index: ' + sortedDirectionDisplays[n].index);
				    routelegs = sortedDirectionDisplays[n].getDirections().routes[0].legs;
				    for (i=0;i<routelegs.length;i++) {
					    var steps = routelegs[i].steps;
					    for (j=0;j<steps.length;j++) {
						    var nextSegment = steps[j].path;
						    for (k=0;k<nextSegment.length;k++) {
							    linestring = linestring + nextSegment[k].toString().replace('(', '').replace(')', '').replace(',', '') + ', ';
							    polyline.getPath().push(nextSegment[k]);
							    bounds.extend(nextSegment[k]);
						    }
					    }
				    }
			    }
//			    polyline.setMap(map);
			    linestring = linestring.trim();
			    linestring = linestring.substring(0, linestring.length - 2);
				// END get cooordinates for the entire path

			    var routeSegmentAddresses = '';
			    var routeSegmentCoords = '';
			    for (var i = 0; i < sortedDirectionDisplays.length; i++) {
				    routelegs = sortedDirectionDisplays[i].getDirections().routes[0].legs;
				    for (var j = 0; j < routelegs.length; j++) {

					    if (j == 0) {
						    routeSegmentAddresses += routelegs[j].start_address + '|';
						    routeSegmentCoords += routelegs[j].start_location + '|';
					    }

					    if (j == routelegs.length - 1) {
						    routeSegmentAddresses += routelegs[j].end_address + '|';
						    routeSegmentCoords += routelegs[j].end_location + '|';
					    }

					    var waypoints = routelegs[j].via_waypoints;
					    for (var k = 0; k < waypoints.length; k++) {
	                        routeSegmentCoords += waypoints[k] + '|';
					    }
				    }
				    routeSegmentCoords = routeSegmentCoords.substr(0, routeSegmentCoords.length - 1);
				    routeSegmentCoords += '#';
				    routeSegmentAddresses = routeSegmentAddresses.substr(0, routeSegmentAddresses.length - 1);
				    routeSegmentAddresses += '#';
			    }

			    populateZKTextbox('routeSegmentAddressesHolder', routeSegmentAddresses);
			    populateZKTextbox('routePathHolder', linestring);
			    populateZKTextbox('coordsHolder', routeSegmentCoords);
			    zAu.send(new zk.Event(zk.Widget.$('$coordsHolder'), 'onChanging'));

		    } else {
			    alert("Παρακαλώ επιλέξτε 'Σχεδίαση' για να ανανεωθεί η διαδρομή σας");
		    }
	    }
	} else {
		if (!departureValid) {
			jq("#departure").css("border-color", "red");
		} else {
			jq("#departure").css("border-color", "gray");
		}
		if (!arrivalValid) {
			jq("#arrival").css("border-color", "red");
		} else {
			jq("#arrival").css("border-color", "gray");
		}
	}
}

function populateZKTextbox(zkid, value) {
    var txtBox = zk.Widget.$('$' + zkid);
    txtBox.setValue(value);
    txtBox.smartUpdate('value', value);
}

function doLoad(path, points, addr) {
	routeCoords = path;
	pointsCoords = points;
	addresses = addr;
}

function endsWith(str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}

function loadData(pop_places, my_places) {
    popularPlaces = pop_places;
    myPlaces = my_places;
}

function appendStopItem(address, pushStopAddresses) {
	jq("#sortable").append("<li id=\"" + address + "\" class=\"ui-state-default\"><span class=\"ui-icon ui-icon-arrowthick-2-n-s\"></span>" + address + "  <span class=\"deleteStop\">[x]</span></li>");
	jq("#stopsTable").css('display', 'inherit');
	jq("#sortable .deleteStop").click(function () {
		jq(this).parent().remove();

		for (i=0; i<drawingMarkers.length; i++) {
			if (drawingMarkers[i].title == jq(this).parent().attr('id')) {
				drawingMarkers[i].setMap(null);
			}
		}
		var elementIndex = stopAddresses.indexOf(jq(this).parent().attr('id'));
		if (elementIndex > -1) {
			stopAddresses.splice(elementIndex, 1);
		}

		if (jq("#sortable").sortable("toArray").length == 0) {
			jq("#stopsTable").css('display', 'none');
		}
	});

	if (pushStopAddresses) {
		stopAddresses.push(address);
	}
}

]]>
</script>
